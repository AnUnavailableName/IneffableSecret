# UDS统一诊断服务

## 诊断体系结构

<img src=".\.image\UDS统一诊断服务\uds体系结构.png" alt="image-20230609101818917" style="zoom:50%;" />

## 通信流程

<img src=".\.image\UDS统一诊断服务\通信流程.png" alt="image-20230609102247755" style="zoom:80%;" />

​	数据发送从源节点的应用层开始发起，层层向下调用service，到达本节点的物理层，通过数据回读得到confirm并层层上传，同时信号延物理介质传递至接收节点的物理层，由下向上传递信号indication，最终由接收节点的应用程序执行。执行结果由ECU以同样的方式发送返回信号，源节点以同样的方式接收。

## 概念和术语

### 1.客户端（Client）

​	诊断请求的提出者——Tester（诊断仪），发送诊断请求。

### 2.服务器端（Server）

​	诊断响应的提供者——某个ECU，发送诊断响应。

### 3.远程客户端/服务器（Remote Client/Server）

​	两者不在同一网段，可能需要隔着一个网关通讯。

### 4.物理通信

​	采用物理寻址的通信的场景，即客户端跟服务端一对一的诊断通信方式。

### 5.功能通信

​	采用功能通信寻址方式通信的场景，客户端向多个服务器发出同一功能的诊断请求的通信方式。

``` chatgpt解析
在CAN总线中，标准帧和扩展帧都可以用于诊断信息的传输。对于标准帧来说，它所包含的11位ID不具备地址映射的功能，只能用来作为目标节点的基本识别信息。因此，在使用标准帧进行诊断信息传输时，通常需要先建立一个双方约定的私有协议，规定每个参与通信的节点分配到的特定ID，并在各个节点上实现这些ID的识别处理。这样，在发送或接收诊断信息时，各个节点就可以通过特定的ID来区分不同的设备并实现点对点的通讯。

举例来说，假设有五个节点参与诊断信息的传输，节点A需要向节点B发送数据，在这种情况下，可以制定一套ID分配表，例如将10x分配给节点A，20x分配给节点B，30x分配给节点C，40x分配给节点D，50x分配给节点E，其中x表示自定义的其他数字。而节点A在向节点B发送数据时，则需要使用ID为20x的CAN帧作为目标地址，从而保证目标节点为B。

综上，在标准帧下进行CAN总线诊断信息传输时需要自定义协议并事先约定各节点的ID规则，以实现点对点通信。而在扩展帧下进行CAN总线诊断信息传输时，由于其包含的29位ID允许进行具体地址映射，因此可以更灵活地实现信息的精确定向和转发。
```

### 6.源地址和目标地址

​	发送节点地址SA，接收节点地址TA。

## 协议数据单元

​	协议数据单元是一组信息和数据的集合，表示发送和接收方对等实体之间传递的数据和信息。协议数据单元包括：

 * 协议控制信息（PCI）
 * 数据（Data）

​	从数据链路层的角度，有以下传输方式：

1. 单帧传输

* 数据长度<6/7字节
* 报文类型：单帧（SF）

<img src=".\.image\UDS统一诊断服务\单帧发送示意.png" alt="image-20230609110909333" style="zoom: 50%;" />

<img src=".\.image\UDS统一诊断服务\单帧发送时序.png" alt="image-20230609111140379" style="zoom:50%;" />

2. 多帧传输

* 数据长度>6/7字节，最多允许4095字节
* 报文类型：
  * 首帧（FF）：正式数据发送前，由数据发送方发送，描述传输的起始
  * 流控制帧（FC）：传输过程中，由数据接收方发送，控制报文流
  * 连续帧（CF）：传输数据正文

<img src=".\.image\UDS统一诊断服务\多帧传输示意.png" alt="image-20230609111358253" style="zoom: 67%;" />

<img src=".\.image\UDS统一诊断服务\多帧传输时序.png" alt="image-20230609111449428" style="zoom:50%;" />

## 网络层时间参数

​	结尾的s/r表示发送方sender/接收方recevier。

​	A、B、C的含义分别为：

* A：本节点发送消息请求req到确认发送con的时间。
* B：本节点确认发送con到收到对方节点ind的时间。
* C：收到对方节点ind到本节点下一帧发送请求req的时间。

<img src=".\.image\UDS统一诊断服务\网络层时间参数时序.png" alt="image-20230609112226655" style="zoom:50%;" />

## PDU说明

* N_PDU：{N_AI,N_PCI,N_Data}

| 参数名称     | 缩写   | 描述                                            |
| ------------ | ------ | ----------------------------------------------- |
| 寻址信息     | N_AI   | 隐含源地址、目标地址和寻址方式信息              |
| 协议控制信息 | N_PCI  | 用于标识N_PDU类型——单帧、首帧、连续帧、流控制帧 |
| 数据         | N_Data | 包含应用层协议控制信息A_PCI和A_Data             |

#### N_PCI结构

​	协议控制信息描述了此帧的类型、作用以及相关的参数信息，占用1~3个字节，信息传递的“主力”——单帧和连续帧仅占用1字节，首帧占用2字节（需要描述总字节数），流控制帧不需要承载数据，因此占用3字节传输控制参数。

<img src=".\.image\UDS统一诊断服务\网络层协议控制信息PCI.png" alt="image-20230609113920164" style="zoom: 33%;" />

* FS——动作指令
  * 0：继续发送。表示接收方已经准备好接收数量为BS数量的连续帧。
  * 1：等待。要求发送方等待下一帧流控制帧，具体实现方式为重置计时，一般用于接收方没有处理完上一次接收到的连续帧。
  * 2：过载。发送方要发送的数据超出接收方的处理能力，停止传输。
* BS——连续发送数量
  * 0：一次性发送全部数据，不必等待流控制帧。
  * 1~FF：发送BS数量的连续帧后等待流控制帧。
* STmin——两个连续帧最小时间间隔限制
  * 0：以最快速度发送。
  * 01~7F：单位为ms。
  * F1~F9：表示0.1~0.9ms。

## 网络层地址

### 地址格式

​	将N_PDU映射到CAN数据帧的不同位置，构成了4种地址格式:

* 常规寻址(Normal addressing)：11位CAN ID N_AI映射到CAN ID，但没有规定N_AI与CAN ID的具体映射关系。也就是说，与常规通讯一样，仅通过定制化协议规定了某节点要收发哪些id，而从id上没有明确的地址位。
* 常规固定寻址(Normal fixed addressing)：与混合寻址编排方式类似完整定义了N_AI如何映射到29位CAN ID。在29位ID中明确留出了地址的固定位。
* 扩展寻址(Extended addressing)：11位CAN ID N_AI中的N_TA映射到CAN数据帧的第一个字节。N_AI中的其它域映射到CAN ID。一般用于Lin总线，因为总协议仅为诊断留了固定的两个id值。
* 混合寻址(Mixed addressing)：11或29位CAN ID仅用于远程寻址，数据段第一字节为扩展地址。

	## 错误识别和处理

1. SF_DL错误：SF_DL = 0或者SF_DL > 7（常规寻址）

```
假如是SF_DL为非法值，则接收方底层（逻辑链路层）忽略，无indication；
假如应用层介入才判定数据非法，则会发送一个带错误码的响应。（看系统是如何实现的，是硬件部分处理还是软件部分处理。）
```

<img src=".\.image\UDS统一诊断服务\数据长度错误处理.png" alt="image-20230609141029157" style="zoom:50%;" />

2. FF_DL错误

 ```
 假如FF_DL>接收方缓存，接收方网络层应中断报文接收，接收方发送FC，其中FS=Overflow，接收方无indication。（接收方为什么没有？？）
 ```

<img src=".\.image\UDS统一诊断服务\首帧数据长度错误处理.png" alt="image-20230609142127858" style="zoom:50%;" />

```
假如FF_DL<8/7（常规寻址模式为8，扩展或混合寻址为7），网络层忽略FF，接收方无indication，且不发送FC；接收方不会接收到FC帧，则产生一个超时错误。
```

<img src=".\.image\UDS统一诊断服务\首帧数据长度错误2处理.png" alt="image-20230609142406493" style="zoom:50%;" />

3. SN错误

```
CF N_PDU中的SN错误，如连续的两帧CF的SN不连续，报文接收应被中断，接收方网络层应指示上层<Result>=N_WRONG_SN，并不会发送FC帧，导致发送方的网络层超时错误。
```

<img src=".\.image\UDS统一诊断服务\SN错误处理.png" alt="image-20230609142929877" style="zoom:50%;" />

4. FS错误

```
如果发送方网络发现接收到的FC N_PDU中的FS错误，那么报文发送被中断，发送方网络层确认上层<result>=N_INCLLID_FS，并不再发送CF，导致接收方超时错误。
```

<img src=".\.image\UDS统一诊断服务\FS错误处理.png" alt="image-20230609143236296" style="zoom:50%;" />

5. 等待次数超限（N_WFTmax）错误

```
接收方最多连续发送要求发送方等待的FC数量N_WFTmax，为服务器本地变量，初始化后应正确设置，避免发送方节点一直处于等待状态。
```

<img src=".\.image\UDS统一诊断服务\等待指令FC帧数量限制.png" alt="image-20230609144005811" style="zoom:50%;" />

6. ST错误

```
ST字段大小为1字节，但其中有些数值是保留值，没有规定其意义，当发送方接收到FC帧的ST域为保留值时，按协议规定的最大值处理（7F-127ms），双方都不会有错误汇报。
```

<img src=".\.image\UDS统一诊断服务\协议规定ST数值描述.png" alt="image-20230609144429109" style="zoom:50%;" />

7. 非预期帧的处理

```
在多包报文传输过程中，任何一方接收到的非期望报文(同一个N_AI)，网络设计者确定网络采用全双工或半双工，然后依据节点处于接收状态，发送状态及空闲状态时，接收到非预期报文，网络层的处理方法不同:半双工状态，网络层处于发送状态，收到任何数据报文，均忽略;全双工状态，除SF和物理寻址的FF外，其它包括功能寻址FF均作忽略处理，且不向上层报告。
```

<img src=".\.image\UDS统一诊断服务\非预期帧处理.png" alt="image-20230609155321143" style="zoom: 50%;" />

## 统一诊断服务的实现

### 1.服务和功能分类

<img src=".\.image\UDS统一诊断服务\诊断功能和服务.png" alt="image-20230609190535287" style="zoom:50%;" />

### 2.SID

<img src=".\.image\UDS统一诊断服务\服务标识符SI.png" alt="image-20230609191915512" style="zoom:50%;" />

### 3.刷写流程

<img src=".\.image\UDS统一诊断服务\刷写流程.png" alt="image-20230612072327330" style="zoom:50%;" />

### 4.请求、肯定/否定响应的格式

|          |             请求服务SI             |             肯定响应SI              |                    否定响应NR_SI                    |
| :------: | :--------------------------------: | :---------------------------------: | :-------------------------------------------------: |
| 数据类型 |          1字节无符号整数           |           1字节无符号整数           |                   1字节无符号整数                   |
|    ID    |             0bX0XXXXXX             |           相应请求ID+0x40           |                         7F                          |
|   示例   | ReadDTCInformation服务Request 0x19 | ReadDTCInformation服务Response 0x59 | NR_SI:0x7F<br />请求标识符:0x19<br />错误代码:0xXXX |

### 5.服务响应的执行规则

带子功能参数的请求消息的响应，对物理寻址的客户端请求消息。

<img src=".\.image\UDS统一诊断服务\带子功能参数响应.png" alt="image-20230612075247497" style="zoom:50%;" />

对不带子功能参数的请求消息的响应，对物理寻址的客户端请求消息。

<img src=".\.image\UDS统一诊断服务\不带子功能参数的响应.png" alt="image-20230612075414554" style="zoom:50%;" />

对不带子功能参数的请求消息的响应，对功能寻址的客户端请求消息。

<img src=".\.image\UDS统一诊断服务\对不带子功能参数功能寻址的响应.png" alt="image-20230612075551793" style="zoom:50%;" />

<img src=".\.image\UDS统一诊断服务\不同服务器对功能寻址请求的响应.png" alt="image-20230612075856481" style="zoom:50%;" />

### 6.应用层定时参数

<img src=".\.image\UDS统一诊断服务\应用层定时参数.png" alt="image-20230612080232372" style="zoom:50%;" />

<img src=".\.image\UDS统一诊断服务\会话相关的时间参数.png" alt="image-20230612080543550" style="zoom:50%;" />